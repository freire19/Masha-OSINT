name: Deploy to VPS

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy to VPS
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        password: ${{ secrets.VPS_PASSWORD }}
        port: 22
        script: |
          set -e

          echo "ğŸš€ Starting deployment..."

          # Navigate to app directory
          cd /opt/masha-osint || {
            echo "ğŸ“¦ First time setup - installing application..."

            # Initial setup
            export DEBIAN_FRONTEND=noninteractive
            apt update
            apt install -y python3 python3-pip python3-venv git nginx certbot python3-certbot-nginx ufw fail2ban

            # Configure firewall
            ufw --force enable
            ufw allow 22/tcp
            ufw allow 80/tcp
            ufw allow 443/tcp

            # Create user
            if ! id -u masha > /dev/null 2>&1; then
              useradd -m -s /bin/bash masha
              usermod -aG sudo masha
            fi

            # Setup app directory
            mkdir -p /opt/masha-osint
            chown masha:masha /opt/masha-osint
            cd /opt/masha-osint
          }

          # Pull latest code
          echo "ğŸ“¥ Pulling latest code..."
          if [ -d ".git" ]; then
            sudo -u masha git pull origin main
          else
            sudo -u masha git clone https://github.com/freire19/Masha-OSINT.git .
          fi

          # Update dependencies
          echo "ğŸ“¦ Installing dependencies..."
          sudo -u masha bash << 'VENV_SETUP'
          cd /opt/masha-osint
          python3 -m venv venv
          source venv/bin/activate
          pip install --upgrade pip -q
          pip install -r requirements.txt -q
          VENV_SETUP

          # Ensure .env exists
          if [ ! -f ".env" ]; then
            sudo -u masha cp .env.example .env
            sudo -u masha chmod 600 .env
            echo "âš ï¸  WARNING: Configure API keys in /opt/masha-osint/.env"
          fi

          # Create/update systemd service
          if [ ! -f "/etc/systemd/system/masha-osint.service" ]; then
            echo "âš™ï¸  Creating systemd service..."
            cat > /etc/systemd/system/masha-osint.service << 'EOF'
          [Unit]
          Description=Masha OSINT - Streamlit Web UI
          After=network.target

          [Service]
          Type=simple
          User=masha
          WorkingDirectory=/opt/masha-osint
          Environment="PATH=/opt/masha-osint/venv/bin"
          EnvironmentFile=/opt/masha-osint/.env
          ExecStart=/opt/masha-osint/venv/bin/streamlit run app.py --server.port=8501 --server.address=127.0.0.1 --server.headless=true --server.enableCORS=false
          Restart=always
          RestartSec=10
          NoNewPrivileges=true
          PrivateTmp=true
          ReadWritePaths=/opt/masha-osint/logs /opt/masha-osint/data

          [Install]
          WantedBy=multi-user.target
          EOF

            systemctl daemon-reload
            systemctl enable masha-osint
          fi

          # Setup Nginx if not configured
          if [ ! -f "/etc/nginx/sites-available/masha-osint" ]; then
            echo "ğŸŒ Configuring Nginx..."
            cat > /etc/nginx/sites-available/masha-osint << 'EOF'
          upstream streamlit_backend {
              server 127.0.0.1:8501 fail_timeout=0;
          }

          server {
              listen 80;
              listen [::]:80;
              server_name masha.freirecorporation.com;

              location / {
                  proxy_pass http://streamlit_backend;
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade $http_upgrade;
                  proxy_set_header Connection "upgrade";
                  proxy_set_header Host $host;
                  proxy_buffering off;
              }
          }
          EOF

            ln -sf /etc/nginx/sites-available/masha-osint /etc/nginx/sites-enabled/
            rm -f /etc/nginx/sites-enabled/default
            nginx -t && systemctl reload nginx

            # Get SSL certificate
            certbot --nginx -d masha.freirecorporation.com --non-interactive --agree-tos --email admin@freirecorporation.com --redirect 2>/dev/null || echo "âš ï¸  SSL: Run manually 'certbot --nginx -d masha.freirecorporation.com'"
          fi

          # Configure Streamlit
          mkdir -p /opt/masha-osint/.streamlit
          cat > /opt/masha-osint/.streamlit/config.toml << 'EOF'
          [server]
          port = 8501
          address = "127.0.0.1"
          headless = true
          [browser]
          serverAddress = "masha.freirecorporation.com"
          serverPort = 443
          [theme]
          base = "dark"
          primaryColor = "#00ff00"
          EOF
          chown -R masha:masha /opt/masha-osint/.streamlit

          # Restart service
          echo "ğŸ”„ Restarting service..."
          systemctl restart masha-osint

          # Verify
          sleep 5
          if systemctl is-active --quiet masha-osint; then
            echo "âœ… Deployment successful!"
            echo "ğŸ“Š Service status:"
            systemctl status masha-osint --no-pager -l | head -10
          else
            echo "âŒ Service failed to start"
            journalctl -u masha-osint -n 20 --no-pager
            exit 1
          fi

    - name: Verify Deployment
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        password: ${{ secrets.VPS_PASSWORD }}
        port: 22
        script: |
          echo "ğŸ” Verifying deployment..."

          # Check service
          if systemctl is-active --quiet masha-osint; then
            echo "âœ… Service is running"
          else
            echo "âŒ Service is not running"
            exit 1
          fi

          # Check Nginx
          if systemctl is-active --quiet nginx; then
            echo "âœ… Nginx is running"
          else
            echo "âŒ Nginx is not running"
            exit 1
          fi

          # Check if responding
          if curl -s http://localhost:8501 > /dev/null; then
            echo "âœ… Application responding"
          else
            echo "âš ï¸  Application not responding on port 8501"
          fi

          echo ""
          echo "ğŸ‰ Deployment completed successfully!"
          echo "ğŸŒ Access: https://masha.freirecorporation.com"
